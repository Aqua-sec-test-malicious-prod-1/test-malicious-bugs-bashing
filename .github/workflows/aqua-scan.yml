name: Aqua Security Scan - SLK-107908 Prod Verify

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  # Test 1: Custom CSPM + AQUA_REGION (should PASS with the fix)
  test-custom-cspm-with-region:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Run Aqua scanner - Custom CSPM with AQUA_REGION
        uses: docker://aquasec/aqua-scanner
        with:
          args: trivy fs --scanners vuln,secret .
        env:
          AQUA_KEY: ${{ secrets.AQUA_KEY }}
          AQUA_SECRET: ${{ secrets.AQUA_SECRET }}
          # Real AQUA_URL for authentication
          AQUA_URL: https://api.asia-1.supply-chain.cloud.aquasec.com
          # Simulating custom CSPM - using real URL but scanner treats it as "unknown"
          # Actually use real URL so auth works - the region will still be used
          CSPM_URL: https://asia-1.api.cloudsploit.com
          # NEW: AQUA_REGION flag from SLK-107908 fix
          AQUA_REGION: singapore
          GITHUB_TOKEN: ${{ github.token }}
          TRIVY_RUN_AS_PLUGIN: aqua

  # Test 2: Verify error message with truly custom CSPM (no region)
  # This should fail with our NEW error message proving fix is deployed
  test-custom-cspm-no-region:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    continue-on-error: true  # Expected to fail
    steps:
      - uses: actions/checkout@v4

      - name: Run Aqua scanner - Custom CSPM WITHOUT region (should fail)
        uses: docker://aquasec/aqua-scanner
        with:
          args: trivy fs --scanners vuln,secret .
        env:
          AQUA_KEY: ${{ secrets.AQUA_KEY }}
          AQUA_SECRET: ${{ secrets.AQUA_SECRET }}
          AQUA_URL: https://api.asia-1.supply-chain.cloud.aquasec.com
          # Fake custom CSPM URL - not in known list
          CSPM_URL: https://my-custom-proxy.example.com
          # NO AQUA_REGION - should trigger new error message
          GITHUB_TOKEN: ${{ github.token }}
          TRIVY_RUN_AS_PLUGIN: aqua
